# ex 命令

ex 是 vim 的命令行模式。

ex 命令以 `:` 开始，由行地址和命令组成，以回车键结束。

`:h 命令` 查看帮助。

## 使用 ex 进行编辑

| 指令          | 说明 |
| ------------- | ---- |
| d(delete)     | 删除 |
| m(move)       | 移动 |
| t(co copy to) | 拷贝 |
| s(substitute) | 替换 |

操作的示例：

- `:3,5 d` 删除 3-5 行
- `:.,$ d` 删除 当前行到最后一行 的内容。
- `:20,30 m 50` 把 20-30 行的内容 _移动_ 到 50 行的后面
- `:20,30 t 50` 把 20-30 行的内容 _复制_ 到 50 行的后面
- `:6t.` 把第六行复制到当前行下方
- `:t6` 把当前行复制到第 6 行下方
- `:'<,'>m$` 把选中的行移动到文件底部

在复制较远的行时 `:t` 更高效

还有一些示例：

- `:=` 显示总行数

## 行地址符

| 指令    | 说明                                                                    |
| ------- | ----------------------------------------------------------------------- |
| .       | 当前行                                                                  |
| 0       | 文件的 0 行，文件的开头                                                 |
| $       | 文件的最后一行                                                          |
| %       | 文件的每一行                                                            |
| +       | .+20 当前行后面的 20 行                                                 |
| -       | .-2 上千行的上面 2 行 （如果当前行真的是假定的开始行，那么 . 可以省略） |
| pattern | 也可以使用模式去匹配行                                                  |

- `:-10,+5 t 0` 复制 【当前行 -10 行，当前行 +5 行】 粘贴到文件的开头
- `:6t.` 把第六行复制到当前行的下方 \*`:t.` 类似于 yyp。区别是不会记录到寄存器中。
- `:6t.` 把第六行复制到当前行的下方 \*`:t.` 类似于 yyp。区别是不会记录到寄存器中。
- `:[line]put [x]` 在指定行后粘贴寄存器 x 中的内容 举例 :0put a
- `:%normal A;` 对每一行执行 normal 命令

## 搜索模式

- `:/pattern/d` 删除匹配到的行
- `:/pattern/+ d` 删除匹配到的行的下一行
- `:/^#/,/^\*/d`
- `:/^#/,/^\*/d`

> `:g/^/norm I*^[ o^[` 其中 `^[` 不是自己手动输入的，而是通过按 `Ctrl+v` + `<Ctrl-[` 产生的。
>
> `:g/^/exe "norm I* \<Esc> o \<Esc>"` 也可以做到

## 命令行执行 normal 模式命令

1000 行文件，每行后面加个；

```bash
A;<Esc>
:'<,'>normal.
```

`:%normalA;` 整个文件后面都执行添加；操作

重复上次的 ex 命令，使用 `@:` 在执行过一次 `@:`之后就可以使用 `@@` 来重复它啦，

如果在 `:bn` 操作中多按了几次，可使用 `<C-o>` 返回

## 组合 ex 命令

可以通过竖直线`|` 进行命令的组合。

- `:1,3d | s/thier/their/` 先删除第 1 行到第 3 行，然后在当前行进行替换。
- `:1,5 m 10 | g/pattern/ norm` 先把第 1 行到第 5 行移动到第 10 行的后面，然后进行 g 操作

## 执行外部命令

- `:! ls` 执行外部命令

## 重复上一次的命令

在执行完命令行命令之后，我们可以使用`@:` 来重复上次的命令，然后就可以再使用 `@@` 来重复上次的命令了。

如果你走过去了，那么可以使用 `<C-o>` 命令撤回到上次

## 文件操作

- :w 把缓存区的内容写入到文件，但是不退出
- :q 退出
- :wq! ! 表示强制执行。此命令表示强制保存并退出

### 保存部分内容到新文件

- :20,$ w newfile 把第 20 行到文件末尾保存到一个新文件中
- :30,$ w >> filename 把 30 行到文件末尾添加到 filename 文件的尾部

### 复制别的文件到现文件中

- :r filename 读取文件的内容，然后插入到当前编辑文本的光标位置后面一行
- :10r filename 将 filename 的文本输入到当前文件的第 10 行后面

如果文件在其他目录下，只需要加上路径即可。例如：

- :r /home/time/data 把 /home/time 目录下的 data 内容插入当前编辑文件

应用地址符组合或搜索模式可以更灵活：

- :$r /home/tim/data 把读取的文件内容加到当前编辑文件的末尾
- :0r /home/tim/data 把读取的文件内容加到文件开头位置
- :/pattern/r /home/tim/data 将读取的文件内容加到当前文件包行模式 /pattern 的行的后面

- `:r!uuidgen` 在当前行插入 uuid

### 编辑多个文件

- `vim a.md b.md` 一次性打开多个文件。使用 `:bn[ext]` 切换到下一个文件，使用 `:bp[revious]` 切换到上一个。或者使用 `:bn[umber]` 直接打开

- :e filename 使用这个命令切换到新文件时，vim 会把之前的文件记为 #，当前的文件记录为 % 。因此可以使用
  - :e # 切换到上一个。Ctrl+^ 效果相同
  - :e! # 放弃当前文件，返回到上一个文件中。

## global 命令

对文件中的行，现进行正则匹配到目标行，然后对目标行执行一定的操作

```bash
:[range]g[lobal][!]/{pattern}/{command}
```

| 指令    | 说明                                   |
| ------- | -------------------------------------- |
| range   | 文本范围，不写默认就是整个文档（%）    |
| !       | 取反。指筛选出不匹配的行。也可以写成 v |
| command | 默认是输入包含 pattern 的行            |

如果不写 g，那么会对 range 整体执行命令。例如 :%/vim/d 只要文档中有 vim，按个整个文档就会被删除。

### 插入空行

比如在 20 行到 200 行之间，每一行下插入空行：

```bash
:20,200g/^/pu _
```

说明：

- ^ 表示匹配行的头部；pu 是 ex 指令，是单词 put 的缩写，表示粘贴、放置；
- 下划线 \_ 是黑洞寄存器，黑洞寄存器里面啥也没有，
- 所以 pu \_ 就相当于在每行下方插入空行。

### 用法示例

「不以 # 或者 空白符 开始的行」

```bash
:g/\v^[^#\s]/t$
```

匹配以 # 开头的行，并且复制到文件底部

```bash
:g/^#/t$
```

匹配不以 # 开头的行，并且复制到文件底部

```bash
:g!/^#/t$
```

删除空白行

```bash
:g/^$/d
```

删除大量匹配行

```bash
g/pattern/d_
```

vim 在删除时，会先把删除的内容放到寄存器中，处理拷贝要花时间，因此可以不拷贝，删除到 黑洞寄存器中。

反转文件中的每一行

```bash
:g/^/m0
```

### 结合替换指令 s 使用

```bash
:g/pattern/s/old//new/gc
```

对匹配到的行，执行替换操作，且需要确认

- y: 替换本处匹配
- n: 不替换本处匹配
- a: 替换此处之后的所有匹配项，随后退出本次替换
- q: 退出本次替换
- l: 替换此处之后推出本次替换

### 在匹配的行后添加文字

在每行尾插入字符串 name

```bash
:%s/$/name
```

### 使用示例

1.  为数组中的每一项增加个属性 id: xx 先写一项，qq 录制宏，4j p c-a q 4@q

2.  有

```bash
  aaaaaaaa
  bbbbbbbbbbbbb
  ccccc
  ddddddd
```

怎么变成 data[0] = "aaaaaa" ...

1. 可以选择后替换，
2. 然后用 c-v g c-a 变更序列号

## 命令补全

- 使用 `Tab` 自动补全
- 使用 `<C-d>` 可以显示完整列表，输入开头字母，比如 :e 按 `Tab` 可以补全
- 使用 `<C-r><C-w>` 可以把当前单词插入命令行
- 使用 `<C-r><C-a>` 可以插入光标下的字符串
- `:reg` 查看寄存器内容
- 你可以输入一部分命令，然后使用 上下箭头 来匹配这部分开头的命令

使用 set history=200 可以设置历史记录为 200

## 命令行窗口

- `q:` 打开 Ex 命令历史的命令行窗口。可以做修改，然后使用 CR 执行命令，或者使用`:q` 退出
- `<Ctrl-f>` 从命令行模式切换到命令行窗口，修改完后，按 <CR> 就会执行
- `:! ls` 执行外部命令
- `q/` 打开查找命令历史的命令行窗口

- `:shell`启动一个 shell 可以执行多条命令，输入 exit 返回 vim
- `:read !{cmd}` 在 shell 中执行 {cmd} ，并把其标准输出插入光标下方
- `:[range]write !{cmd}` 在 shell 中执行 {cmd} ，以 [range] 作为其标准输入
